# Logstash 8.x GeoIP Test Pipeline with elastic_integration filter
input {
  # Generator for quick testing - produces IP addresses with data_stream fields
  generator {
    lines => [
      '{"@timestamp": "2026-02-04T12:00:00Z", "message": "test event", "source": {"ip": "8.8.8.8"}, "data_stream": {"type": "logs", "dataset": "geoip.test", "namespace": "default"}}',
      '{"@timestamp": "2026-02-04T12:00:01Z", "message": "test event", "source": {"ip": "1.1.1.1"}, "data_stream": {"type": "logs", "dataset": "geoip.test", "namespace": "default"}}',
      '{"@timestamp": "2026-02-04T12:00:02Z", "message": "test event", "source": {"ip": "93.184.216.34"}, "data_stream": {"type": "logs", "dataset": "geoip.test", "namespace": "default"}}'
    ]
    count => 1
    codec => json
  }
}

filter {
  # elastic_integration filter - runs ES ingest pipelines in Logstash
  # Uses data_stream.dataset to find matching ingest pipeline: logs-{dataset}-default
  elastic_integration {
    hosts => ["${ELASTICSEARCH_HOSTS}"]
    ssl_enabled => false
    add_field => {
      "calculated_by" => "elastic_integration"
    }
  }

  # Also run local geoip filter for comparison (uses upgraded GeoIP 4.x plugin)
  if [source][ip] {
    geoip {
      source => "[source][ip]"
      target => "[source][geo]"
      tag_on_failure => ["_geoip_filter_lookup_failure"]
      add_field => {
        "calculated_by" => "geoip"
      }
    }
  }

  mutate {
    add_field => {
      "logstash_version" => "8.x"
    }
  }
}

output {
  # Output to data stream
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOSTS}"]
    ssl_enabled => false
    data_stream => true
    data_stream_type => "logs"
    data_stream_dataset => "geoip.test"
    data_stream_namespace => "default"
  }

  stdout {
    codec => rubydebug
  }
}
